<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản trị - Quản lý Đơn hàng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        #sidebar { min-height: 100vh; }
        #sidebar .nav-link { color: #fff; transition: background-color 0.3s, color 0.3s; }
        #sidebar .nav-link:hover { background-color: #0056b3; color: #fff; }
        #sidebar .nav-link.active { background-color: #0d6efd; color: #fff; }
        thead { color: #fff; background: #333333; }
        .card-header { color: #fff; background: #333333; }
        #notification { display: none; }
        #notification-dropdown { position: relative; cursor: pointer; }
        #notification-bell { font-size: 1.8em; color: #0d6efd; }
        #notification-count { position: absolute; top: 0; right: 0; font-size: 0.8em; }
        #notification-list {
            display: none;
            position: absolute;
            right: 0;
            top: 35px;
            width: 300px;
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 0;
            list-style: none;
            z-index: 1000;
        }
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            font-size: 0.9em;
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#"><i class="bi bi-speedometer2"></i> Quản Lý</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/category/admin"><i class="bi bi-list"></i> Quản Lý Danh Mục</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/order/admin"><i class="bi bi-bag"></i> Quản Lý Đơn Hàng</a>
                </li>
            </ul>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <h1 class="h2 mt-4">Quản lý Đơn hàng</h1>

            <!-- Chuông thông báo -->
            <div id="notification-dropdown" style="position: relative; display: inline-block; margin-bottom: 10px;">
                <i id="notification-bell" class="bi bi-bell"></i>
                <span id="notification-count" class="badge bg-danger" style="display: none;"></span>
                <!-- Danh sách thông báo -->
                <ul id="notification-list">
                    <li class="notification-item">Không có thông báo mới</li>
                </ul>
            </div>
            <!-- Form Thêm / Sửa Đơn Hàng -->
            <div class="card mb-4">
                <div class="card-header">Thêm/Chỉnh sửa Đơn hàng</div>
                <div class="card-body">
                    <form th:action="@{/order/save}" th:object="${order}" method="post">
                        <input type="hidden" th:field="*{id}"/>
                        <div class="mb-3">
                            <label class="form-label">Tên Khách Hàng</label>
                            <input type="text" class="form-control" th:field="*{fullName}" placeholder="Tên khách hàng" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Địa Chỉ</label>
                            <input type="text" class="form-control" th:field="*{address}" placeholder="Địa chỉ" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Số Điện Thoại</label>
                            <input type="text" class="form-control" th:field="*{phone}" placeholder="Số điện thoại" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Trạng Thái</label>
                            <select class="form-select" th:field="*{status}">
                                <option value="CHO_XAC_NHAN">Chờ Xác Nhận</option>
                                <option value="CHO_THANH_TOAN">Chờ Thanh Toán</option>
                                <option value="DA_THANH_TOAN">Đã Thanh Toán</option>
                                <option value="DA_HUY">Đã Hủy</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tổng Tiền</label>
                            <input type="number" class="form-control" th:field="*{totalAmount}" placeholder="Tổng tiền" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Lưu Đơn hàng</button>
                    </form>
                </div>
            </div>

            <!-- Bảng quản lý đơn hàng -->
            <div class="card mb-4">
                <div class="card-header">Danh sách Đơn hàng</div>
                <div class="card-body">
                    <table class="table table-striped table-bordered" id="orderTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên Khách Hàng</th>
                            <th>Địa Chỉ</th>
                            <th>Số Điện Thoại</th>
                            <th>Trạng Thái</th>
                            <th>Tổng Tiền</th>
                            <th>Hành Động</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="order : ${orders}">
                            <td th:text="${order.id}">1</td>
                            <td th:text="${order.fullName}">Nguyễn Văn A</td>
                            <td th:text="${order.address}">123 Đường Chính</td>
                            <td th:text="${order.phone}">0123456789</td>
                            <td th:text="${order.status}">Chờ Thanh Toán</td>
                            <td th:text="${#numbers.formatDecimal(order.totalAmount, 1, 'COMMA', 2, 'POINT')}">1,000,000</td>
                            <td>
                                <a th:href="@{/order/edit/{id}(id=${order.id})}" class="btn btn-sm btn-warning">Sửa</a>
                                <a th:href="@{/order/delete/{id}(id=${order.id})}" class="btn btn-sm btn-danger" onclick="return confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')">Xóa</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Các script cần thiết -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.4.0/dist/sockjs.min.js"></script>

<script>
    $(document).ready(function() {
        var stompClient = null;
        const NOTIFICATION_EXPIRY_TIME = 3600000; // 1 giờ trong milliseconds

        function checkAndDisplayStoredNotifications() {
            let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
            const currentTime = Date.now();
            notifications = notifications.filter(notification => (currentTime - notification.time) < NOTIFICATION_EXPIRY_TIME);
            localStorage.setItem('notifications', JSON.stringify(notifications));

            if (notifications.length > 0) {
                $('#notification-count').text(notifications.length).show();
                $('#notification-list').empty();
                notifications.forEach(notification => {
                    $('#notification-list').append(`<li class="notification-item">${notification.message}</li>`);
                });
            } else {
                $('#notification-count').hide();
                $('#notification-list').html('<li class="notification-item">Không có thông báo mới</li>');
            }
        }

        function connect() {
            var socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function(frame) {
                stompClient.subscribe('/topic/orderPayment', function(message) {
                    const notification = { message: message.body, time: Date.now() };
                    let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
                    notifications.push(notification);
                    localStorage.setItem('notifications', JSON.stringify(notifications));

                    // Thêm thông báo mới vào danh sách ngay lập tức
                    $('#notification-list').append(`<li class="notification-item">${notification.message}</li>`);
                    $('#notification-count').text(notifications.length).show();
                });
            });
        }

        // Tự động cập nhật danh sách thông báo mỗi 2 giây
        setInterval(function() {
            checkAndDisplayStoredNotifications();
        }, 2000);

        $('#notification-dropdown').click(function() {
            $('#notification-list').toggle();
            $('#notification-count').hide();
        });

        $(document).click(function(event) {
            if (!$(event.target).closest('#notification-dropdown').length) {
                $('#notification-list').hide();
            }
        });

        checkAndDisplayStoredNotifications();
        connect();
    });
</script>


</body>
</html>
