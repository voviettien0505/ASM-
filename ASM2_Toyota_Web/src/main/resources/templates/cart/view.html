<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Giỏ Hàng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
<div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">Giỏ Hàng của <span th:text="${user.fullName}"></span></h2>

    <!-- Cart Items Table -->
    <table class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden">
        <thead class="bg-gray-200 text-gray-700">
        <tr>
            <th class="py-4 px-6 text-center font-semibold border-b border-gray-300">Chọn</th>
            <th class="py-4 px-6 text-left font-semibold border-b border-gray-300">Tên Sản Phẩm</th>
            <th class="py-4 px-6 text-center font-semibold border-b border-gray-300">Số Lượng</th>
            <th class="py-4 px-6 text-right font-semibold border-b border-gray-300">Giá (₫)</th>
            <th class="py-4 px-6 text-right font-semibold border-b border-gray-300">Tổng Cộng (₫)</th>
            <th class="py-4 px-6 text-center font-semibold border-b border-gray-300">Hành Động</th>
        </tr>
        </thead>
        <tbody class="text-gray-700">
        <tr th:each="cartItem : ${cartItems}" class="hover:bg-gray-50 transition">
            <td class="py-4 px-6 text-center border-b border-gray-300">
                <input type="checkbox" class="item-checkbox" />
            </td>
            <td class="py-4 px-6 border-b border-gray-300" th:text="${cartItem.product.name}">Tên sản phẩm</td>
            <td class="py-4 px-6 text-center border-b border-gray-300" th:text="${cartItem.quantity}">Số lượng</td>
            <td class="py-4 px-6 text-right border-b border-gray-300" th:text="${#numbers.formatDecimal(cartItem.product.price, 1, 'COMMA', 2, 'POINT')}">0</td>
            <td class="py-4 px-6 text-right border-b border-gray-300 total" th:text="${#numbers.formatDecimal(cartItem.quantity * cartItem.product.price, 1, 'COMMA', 2, 'POINT')}">0</td>
            <td class="py-4 px-6 text-center border-b border-gray-300">
                <form th:action="@{/cart/remove}" method="post" th:object="${cartItem}">
                    <input type="hidden" name="cartItemId" th:value="${cartItem.id}"/>
                    <button type="submit" class="text-red-500 hover:text-red-700 font-semibold">
                        Xóa
                    </button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Total Amount Display -->
    <div class="mt-6 flex justify-between items-center">
        <h6 class="text-xl font-bold text-gray-800">Tổng tiền: <span id="total-amount">0</span> ₫</h6>
        <form id="place-order-form" th:action="@{/order/place}" method="post">
            <button type="submit" class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-md hover:bg-blue-700 transition duration-300">
                Đặt Hàng
            </button>
        </form>
    </div>

</div>

<script>
    // Function to calculate and display the total amount for selected items
    function calculateTotal() {
        let total = 0;

        // Iterate over each selected item and sum the total amount
        $('.item-checkbox:checked').each(function() {
            const rowTotal = $(this).closest('tr').find('.total').text().replace(/[₫,]/g, ''); // Remove formatting
            total += parseFloat(rowTotal) || 0; // Add to total, handling NaN values
        });

        // Update the total amount display
        $('#total-amount').text(total.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
    }

    // Calculate total on page load and whenever a checkbox is clicked
    $(document).ready(function() {
        calculateTotal();

        // Recalculate total whenever a checkbox changes
        $('.item-checkbox').on('change', function() {
            calculateTotal();
        });
    });

</script>
<script>
    $(document).ready(function() {
        calculateTotal();

        // Cập nhật tổng tiền khi thay đổi lựa chọn sản phẩm
        $('.item-checkbox').on('change', function() {
            calculateTotal();
        });

        // Xử lý khi nhấn "Đặt Hàng"
        $('#place-order-form').on('submit', function(event) {
            event.preventDefault(); // Ngăn không cho form gửi đi ngay

            // Xóa các input ẩn cũ (nếu có) để tránh trùng lặp
            $('#place-order-form input[name="productIds"]').remove();
            $('#place-order-form input[name="quantities"]').remove();

            // Lấy dữ liệu sản phẩm và số lượng từ các ô checkbox đã chọn
            $('.item-checkbox:checked').each(function() {
                const row = $(this).closest('tr');
                const productId = row.find('input[name="cartItemId"]').val(); // ID sản phẩm
                const quantity = row.find('td:nth-child(3)').text().trim(); // Số lượng

                // Thêm thông tin sản phẩm và số lượng dưới dạng input ẩn vào form
                $('#place-order-form').append(`<input type="hidden" name="productIds" value="${productId}">`);
                $('#place-order-form').append(`<input type="hidden" name="quantities" value="${quantity}">`);
            });

            // Gửi form sau khi đã thêm input ẩn
            this.submit();
        });
    });

    // Hàm tính tổng tiền các sản phẩm đã chọn
    function calculateTotal() {
        let total = 0;

        $('.item-checkbox:checked').each(function() {
            const rowTotal = $(this).closest('tr').find('.total').text().replace(/[₫,]/g, '');
            total += parseFloat(rowTotal) || 0;
        });

        $('#total-amount').text(total.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }));
    }

    $('#place-order-form').on('submit', function(event) {
        if ($('.item-checkbox:checked').length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để đặt hàng.');
            return false; // Ngăn không cho form gửi đi
        }
        // Phần xử lý tiếp theo
    });

</script>

</body>
</html>
